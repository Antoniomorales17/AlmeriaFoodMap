<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurantes Cercanos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; width: 100%; }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Restaurantes Cercanos</h1>

        <!-- Filtros -->
        <div class="mb-4 flex gap-4">
            <select id="categoryFilter" onchange="filterRestaurants()" class="px-3 py-2 border rounded shadow-sm">
                <option value="">Todas las categorías</option>
                <option value="italiano">Italiano</option>
                <option value="bar">Bar</option>
                <option value="café">Café</option>
                <option value="restaurante">Restaurante</option>
            </select>
            <select id="priceFilter" onchange="filterRestaurants()" class="px-3 py-2 border rounded shadow-sm">
                <option value="">Todos los rangos de precios</option>
                <option value="económico">Económico</option>
                <option value="moderado">Moderado</option>
                <option value="caro">Caro</option>
            </select>
        </div>

        <!-- Lista de restaurantes -->
        <ul id="restaurant-list" class="mb-6 space-y-4">
            {% for restaurant in restaurants %}
            <li 
                class="bg-white p-4 rounded-lg shadow-md cursor-pointer"
                onclick="highlightRestaurant({{ restaurant.latitude }}, {{ restaurant.longitude }}, '{{ restaurant.name }}', '{{ restaurant.address }}')"
                data-category="{{ restaurant.category }}" 
                data-price="{{ restaurant.price_range }}">
                
                <!-- Mostrar la imagen del restaurante -->
                <img src="{{ restaurant.image_url }}" alt="{{ restaurant.name }}" class="w-full h-32 object-cover rounded mb-2">




                
                <h2 class="text-lg font-semibold">{{ restaurant.name }}</h2>
                
                <!-- Información básica -->
                <p class="text-sm text-gray-600">{{ restaurant.address }}</p>
                <p class="text-sm text-gray-600">Horario: {{ restaurant.opening_time }} - {{ restaurant.closing_time }}</p>
                
                <!-- Información adicional -->
                <p class="text-sm text-gray-600">Teléfono: {{ restaurant.phone }}</p>
                <p class="text-sm text-gray-600">
                    Página web: 
                    {% if restaurant.website %}
                        <a href="{{ restaurant.website }}" class="text-blue-500 hover:underline" target="_blank">{{ restaurant.website }}</a>
                    {% else %}
                        No disponible
                    {% endif %}
                </p>
                <p class="text-sm text-gray-600">Categoría: {{ restaurant.category }}</p>
                <p class="text-sm text-gray-600">Rango de precios: {{ restaurant.price_range }}</p>
            </li>
            {% endfor %}
        </ul>

        <!-- Mapa -->
        <div id="map" class="rounded-lg shadow-lg"></div>
    </div>

    <script>
        // Configuración inicial del mapa centrado en Almería
        var map = L.map('map').setView([36.8340, -2.4637], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    
        var markers = [];
    
        // Cargar los restaurantes y ubicarlos en el mapa desde el contexto de Django
        var restaurants = [
            {% for restaurant in restaurants %}
            {
                'name': '{{ restaurant.name }}',
                'lat': {{ restaurant.latitude }},
                'lng': {{ restaurant.longitude }},
                'address': '{{ restaurant.address }}',
                'category': '{{ restaurant.category }}',
                'price_range': '{{ restaurant.price_range }}',
                'image_url': '{{ restaurant.image.url }}'
            },
            {% endfor %}
        ];
    
        // Crear los marcadores en el mapa para cada restaurante
        restaurants.forEach(function(restaurant) {
            if (restaurant.lat && restaurant.lng) {
                var popupContent = `
                    <div style="text-align: center;">
                        <b>${restaurant.name}</b><br>
                        <img src="${restaurant.image_url}" alt="${restaurant.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin: 10px 0;">
                        <p>${restaurant.address}</p>
                    </div>
                `;
    
                var marker = L.marker([restaurant.lat, restaurant.lng])
                    .addTo(map)
                    .bindPopup(popupContent);
    
                markers.push(marker);
            }
        });
    
        // Función para resaltar un restaurante en el mapa
        function highlightRestaurant(lat, lng) {
            map.setView([lat, lng], 15);
            var selectedMarker = markers.find(m => m.getLatLng().lat === lat && m.getLatLng().lng === lng);
            if (selectedMarker) {
                selectedMarker.openPopup();
            }
        }

        // Función para filtrar restaurantes
        function filterRestaurants() {
            var category = document.getElementById('categoryFilter').value;
            var price = document.getElementById('priceFilter').value;
            
            var restaurantList = document.querySelectorAll('#restaurant-list li');
            
            restaurantList.forEach(function(restaurant) {
                var restaurantCategory = restaurant.getAttribute('data-category');
                var restaurantPrice = restaurant.getAttribute('data-price');
    
                if ((category === "" || restaurantCategory === category) &&
                    (price === "" || restaurantPrice === price)) {
                    restaurant.style.display = "block";
                } else {
                    restaurant.style.display = "none";
                }
            });
        }
    </script>
</body>
</html>
